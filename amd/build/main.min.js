define("local_edusupport/main",["jquery","core/ajax","core/notification","core/str","core/url","core/modal_factory","core/modal_events","core/templates"],(function($,AJAX,NOTIFICATION,STR,URL,ModalFactory,ModalEvents,Templates){return{debug:0,modal:void 0,screenshot:"",screenshotname:"",triggerSteps:0,assignSupporter:function(discussionid){var MAIN=this;console.log("ajax call"),AJAX.call([{methodname:"local_edusupport_get_potentialsupporters",args:{discussionid:discussionid},done:function(result){try{result=JSON.parse(result)}catch(e){}MAIN.debug>0&&console.log("local_edusupport_external:local_edusupport_get_potentialsupporters",result);var supportlevels=Object.keys(result.supporters),body='<input type="hidden" value="'+discussionid+'" />';body+="<select>";for(var a=0;a<supportlevels.length;a++){body+='<optgroup label="'+supportlevels[a]+'">';for(var b=0;b<result.supporters[supportlevels[a]].length;b++){var supporter=result.supporters[supportlevels[a]][b];body+='<option value="'+supporter.userid+'"'+(supporter.selected?' selected="selected"':"")+">"+supporter.firstname+" "+supporter.lastname+"</option>"}body+="</optgroup>"}body+="</select>",ModalFactory.create({title:STR.get_string("select","core"),type:ModalFactory.types.SAVE_CANCEL,body:body}).done((function(modal){console.log("Created modal"),modal.show(),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault();var data={discussionid:$(this).find(".modal-body input").val(),supporterid:$(this).find(".modal-body select").val()};AJAX.call([{methodname:"local_edusupport_set_currentsupporter",args:data,done:function(result){console.log(result),1==result?top.location.reload():alert("Error: "+result)},fail:NOTIFICATION.exception}])}))}))},fail:NOTIFICATION.exception}])},checkHasScreenshot:function(c){this.debug>0&&console.log("local_edusupport/main:checkHasScreenshot(c)",c),""==$(c).closest("form").find("#screenshot").attr("src")?$(c).closest("form").find("#screenshot_ok").css("display","block"):($(c).closest("form").find("#screenshot_ok").css("display","none"),$(c).closest("form").find("#screenshot").css("display",$(c).is(":checked")?"inline":"none"),$(c).closest("form").find("#screenshot_new").css("display",$(c).is(":checked")?"block":"none"))},generateScreenshot:function(b){MAIN.modal.hide(),require(["local_edusupport/html2canvas"],(function(h2c){console.log("Making screenshot"),h2c(document.body).then((function(canvas){console.log("Got screenshot"),MAIN.canvas=canvas,void 0!==MAIN.modal&&(MAIN.prepareScreenshot(b),MAIN.modal.show())}))}))},injectHelpButton:function(){console.log("local_edusupport/main:injectHelpButton()"),AJAX.call([{methodname:"local_edusupport_get_extralinks",args:{},done:function(result){$(result).insertBefore($("nav.fixed-top .nav .nav-item:last-child"))},fail:NOTIFICATION.exception}])},injectReplyButtons:function(discussion){STR.get_strings([{key:"reply",component:"forum"}]).done((function(s){$('a[href*="issue.php?discussion='+discussion+'&parent="]').remove(),$('a[href*="issue.php?discussion='+discussion+'&delete="]').remove(),$('a[href*="post.php?prune="]').remove(),$(".forum-post-container>.forumpost").each((function(){var postid=$(this).attr("data-post-id");0==$(this).find(".reply-"+postid).length&&$(this).find(".post-actions:first-child").append($('<a data-region="post-action" class="btn btn-link reply-'+postid+'" title="'+s[0]+'" aria-label="'+s[0]+'" role="menuitem" tabindex="-1">').html(s[0]).attr("href",URL.relativeUrl("/local/edusupport/issue.php?discussion="+discussion+"&replyto="+postid+"#mformforum")))}))})).fail(NOTIFICATION.exception)},closeIssue:function(discussionid){console.log("closeIssue(discussionid)",discussionid),AJAX.call([{methodname:"local_edusupport_close_issue",args:{discussionid:discussionid},done:function(result){console.log(result),1==result?top.location.href=URL.relativeUrl("/local/edusupport/issues.php",{}):NOTIFICATION.exception(result)},fail:NOTIFICATION.exception}])},colorize:function(){var discussionids=[];$("table.forumheaderlist tr.discussion td.starter a").each((function(){var d=$(this).attr("href").split("?d=");discussionids[discussionids.length]=d[1]}));var data={discussionids:discussionids};console.log("local_edusupport_colorize",data),AJAX.call([{methodname:"local_edusupport_colorize",args:data,done:function(result){try{result=JSON.parse(result)}catch(e){}if(console.log(result),void 0!==result.styles)for(var discussionids=Object.keys(result.styles),a=0;a<discussionids.length;a++){var discussionid=discussionids[a],style=result.styles[discussionid];$('table.forumheaderlist tr.discussion td.starter a[href$="d='+discussionid+'"]').closest("tr").attr("style",style)}},fail:NOTIFICATION.exception}])},injectForwardButton:function(discussionid,isissue){this.debug&&console.log("local_edusupport/main:injectForwardButton(discussionid, isissue)",discussionid,isissue),void 0!==discussionid&&STR.get_strings([{key:void 0!==isissue&&isissue?"issue_revoke":"issue_assign_nextlevel",component:"local_edusupport"}]).done((function(s){$('#page-content div[role="main"] .discussionname').parent().prepend($('<a href="#">').attr("onclick","require(['local_edusupport/main'], function(MAIN) { MAIN.injectForwardModal("+discussionid+", "+isissue+"); }); return false;").attr("style","float: right").addClass("btn btn-secondary").html(s[0]))})).fail(NOTIFICATION.exception)},injectTest:function(){var discussionname=$(".discussionname");"! "==discussionname.text().substr(0,2)&&discussionname.addClass("alert-warning"),"!!"==discussionname.text().substr(0,2)&&discussionname.addClass("alert-danger")},injectForwardModal:function(discussionid,revoke){STR.get_strings([{key:"confirm",component:"core"},{key:void 0!==revoke&&revoke?"issue_revoke":"issue_assign_nextlevel",component:"local_edusupport"}]).done((function(s){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:s[0],body:s[1]}).done((function(modal){modal.getRoot().on(ModalEvents.save,(function(){top.location.href=URL.relativeUrl("/local/edusupport/forward_2nd_level.php",{d:discussionid,revoke:revoke})})),modal.show()}))})).fail(NOTIFICATION.exception)},postBox:function(modal){var MAIN=this;if(void 0!==MAIN.is_sending&&MAIN.is_sending)console.log("Issue in queue, aborting");else{MAIN.debug>0&&console.log("MAIN.postBox(modal)",modal);var subject=$("#local_edusupport_create_form #id_subject").val(),contactphone=$("#local_edusupport_create_form #id_contactphone").val()||"";console.log(contactphone);var description=$("#local_edusupport_create_form #id_description").val(),forum_group=$("#local_edusupport_create_form #id_forum_group").val(),postto2ndlevel=$("#local_edusupport_create_form #id_postto2ndlevel").prop("checked")?1:0,screenshot=MAIN.screenshot,screenshotname=MAIN.screenshotname,faqread=$("#local_edusupport_create_form #id_faqread").prop("checked")?1:0,guestmail=$("#local_edusupport_create_form #id_guestmail").length?$("#local_edusupport_create_form #id_guestmail").val():null,accountmanager=$("#local_edusupport_create_form #id_accountmanager").length?$("#local_edusupport_create_form #id_accountmanager").val():null,url=top.location.href;if(console.log(""),0!=faqread)if(0!=subject.length)if(subject.length<3||description.length<5){editaPresent=STR.get_string("be_more_accurate","local_edusupport",{});$.when(editaPresent).done((function(localizedEditString){NOTIFICATION.alert("",localizedEditString)}))}else{if(!$("#local_edusupport_create_form #id_guestmail").length||$("#local_edusupport_create_form #id_guestmail").val().match(/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/)){MAIN.is_sending=!0;var imagedataurl=void 0!==screenshot?screenshot:"";console.log(accountmanager),MAIN.debug>0&&console.log("local_edusupport_create_issue",{subject:subject,description:description,forum_group:forum_group,postto2ndlevel:postto2ndlevel,image:imagedataurl,screenshotname:screenshotname,url:url,contactphone:contactphone,guestmail:guestmail,accountmanager:accountmanager}),AJAX.call([{methodname:"local_edusupport_create_issue",args:{subject:subject,description:description,forum_group:forum_group,postto2ndlevel:postto2ndlevel,image:imagedataurl,screenshotname:screenshotname,url:url,contactphone:contactphone,guestmail:guestmail,accountmanager:accountmanager},done:function(result){MAIN.debug>0&&console.log(result),modal.hide();var responsibles="";if(void 0!==result.responsibles){responsibles+='<ul class="edusupport_responsible">';for(var i=0;i<result.responsibles.length;i++){var r=result.responsibles[i];void 0!==r.userid&&r.userid>0?responsibles+='<li><a href="'+URL.fileUrl("/user","view.php?id="+r.userid)+'" target="_blank">'+r.name+"</a></li>":void 0!==r.email&&""!=r.email?responsibles+='<li><a href="mailto:'+r.email+'">'+r.name+"</a></li>":responsibles+="<li>"+r.name+"</li>"}responsibles+="</ul>"}void 0!==result.discussionid&&-999==parseInt(result.discussionid)?STR.get_strings([{key:"create_issue_success_title",component:"local_edusupport"},{key:"create_issue_success_description_mail",component:"local_edusupport"},{key:"create_issue_success_responsibles",component:"local_edusupport"},{key:"create_issue_success_close",component:"local_edusupport"}]).done((function(s){var desc=s[1];""!=responsibles&&(desc=s[2]+responsibles),NOTIFICATION.alert(s[0],desc,s[3])})).fail(NOTIFICATION.exception):void 0!==result.discussionid&&parseInt(result.discussionid)>0?STR.get_strings([{key:"create_issue_success_title",component:"local_edusupport"},{key:"create_issue_success_description",component:"local_edusupport"},{key:"create_issue_success_responsibles",component:"local_edusupport"},{key:"create_issue_success_goto",component:"local_edusupport"},{key:"create_issue_success_close",component:"local_edusupport"}]).done((function(s){var desc=s[1];""!=responsibles&&(desc=s[2]+responsibles),NOTIFICATION.confirm(s[0],desc,s[3],s[4],(function(){top.location.href=URL.fileUrl("/mod/forum","discuss.php?d="+result.discussionid)}))})).fail(NOTIFICATION.exception):STR.get_strings([{key:"create_issue_error_title",component:"local_edusupport"},{key:"create_issue_error_description",component:"local_edusupport"}]).done((function(s){NOTIFICATION.alert(s[0],s[1])})).fail(NOTIFICATION.exception),MAIN.is_sending=!1},fail:NOTIFICATION.exception}])}else{editaPresent=STR.get_string("invalidmail","local_edusupport",{});$.when(editaPresent).done((function(localizedEditString){NOTIFICATION.alert("",localizedEditString)}))}}else{var editaPresent=STR.get_string("select_subject","local_edusupport",{});$.when(editaPresent).done((function(localizedEditString){NOTIFICATION.alert("",localizedEditString)}))}else{var editaPresent=STR.get_string("faqread","local_edusupport",{});$.when(editaPresent).done((function(localizedEditString){NOTIFICATION.alert("",localizedEditString)}))}}},prepareBox:function(){var MAIN=this;MAIN.debug>0&&console.log("Showing modal");var body=$(MAIN.modal.body);body.find("#id_forum_group>option").length<=1&&body.find("#id_forum_group").parent().parent().css("display","none"),MAIN.modal.setLarge(),MAIN.modal.getRoot().on(ModalEvents.save,(function(e){MAIN.postBox(MAIN.modal),e.preventDefault()}));var editaPresent=STR.get_string("create_issue","local_edusupport",{});$.when(editaPresent).done((function(localizedEditString){MAIN.modal.setSaveButtonText(localizedEditString)})),MAIN.modal.show()},prepareScreenshot:function(c){var dataurl=this.canvas.toDataURL();$(this.modal.body).find("img#screenshot").attr("src",dataurl),$("#screenshot").closest("div").css("display",void 0),$("#id_postscreenshot").closest("div.fitem").css("display",void 0),this.checkHasScreenshot($("#id_postscreenshot")),delete this.canvas},showBox:function(forumid){void 0===forumid&&(forumid=0);var MAIN=this;delete MAIN.canvas,void 0!==MAIN.modal?MAIN.prepareBox(forumid):(console.log("Fetching modal"),MAIN.triggerSpinner(1),AJAX.call([{methodname:"local_edusupport_create_form",args:{url:top.location.href,image:"",forumid:forumid},done:function(result){console.log("Got modal"),MAIN.triggerSpinner(-1),$("#local_edusupport_create_form").remove(),ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,body:result,large:1}).done((function(modal){console.log("Created modal"),MAIN.modal=modal,MAIN.prepareBox();MAIN.modal.footer.hide()}))},fail:NOTIFICATION.exception}]))},showSupporter:function(forumid){void 0===forumid&&(forumid=0);var MAIN=this;delete MAIN.canvas,void 0!==MAIN.modal?MAIN.prepareBox(forumid):(console.log("Fetching modal"),MAIN.triggerSpinner(1),AJAX.call([{methodname:"local_edusupport_create_form",args:{url:top.location.href,image:"",forumid:forumid},done:function(result){console.log("Got modal"),MAIN.triggerSpinner(-1),$("#local_edusupport_create_form").remove(),ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,body:result,large:1}).done((function(modal){console.log("Created modal"),MAIN.modal=modal,MAIN.prepareBox()}))},fail:NOTIFICATION.exception}]))},supportCourseMovedAlert:function(title,msg){ModalFactory.create({title:title,type:ModalFactory.types.OK,body:msg}).done((function(modal){modal.show()}))},triggerSpinner:function(steps){MAIN=this,MAIN.triggerSteps+=steps,MAIN.triggerSteps>0?0==$("body #edusupport-spinner").length&&$("body").append($('<div id="edusupport-spinner" class="spinner-grid show"><div></div><div></div><div></div><div></div></div>')):$("#edusupport-spinner").remove()},uploadScreenshot:function(){MAIN=this,$("#edusupport_screenshot input").addClass("disabled"),$("#edusupport_screenshot div.alert").addClass("hidden");var file=document.querySelector('#edusupport_screenshot input[type="file"]').files[0],reader=new FileReader;reader.readAsDataURL(file),void 0!==file.name&&(MAIN.screenshotname=file.name,reader.onload=function(){$("#edusupport_screenshot div.alert-success").removeClass("hidden"),$("#edusupport_screenshot input").removeClass("disabled"),MAIN.screenshot=reader.result,console.log(reader.result)},reader.onerror=function(error){$("#edusupport_screenshot div.alert-danger").removeClass("hidden"),$("#edusupport_screenshot input").removeClass("disabled"),console.log("Error: ",error,file)})}}}));

//# sourceMappingURL=main.min.js.map